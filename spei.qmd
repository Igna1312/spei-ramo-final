---
title: "Análisis SPEI"
format:
  html:
    fig-width: 8
    fig-height: 4
---

## Cargar paquetes y datos

```{r}
# Ejecutar esta línea solo la primera vez si no tienes SPEI instalado:
# install.packages("SPEI")

library(SPEI)

# Leer los CSV
datos_cogoti <- read.csv("data/cogoti_spei.csv", header = TRUE)

datos_ramadas <- read.csv(
  "data/ramadas_spei.csv",
  header = TRUE,
  sep = ";"
)

# Mostrar primeras filas para comprobar que se cargaron bien
head(datos_cogoti)
head(datos_ramadas)
```

## Calcular ETP y balance hídrico – Estación Cogotí

```{r, include=FALSE}
# Capturamos todo lo que imprime hargreaves para que NO aparezca en el HTML
dummy_out_cogoti <- capture.output({
  datos_cogoti$ETP_har <- hargreaves(
    datos_cogoti$tmin,
    datos_cogoti$tmax,
    lat = -31.035833
  )
})

# Balance Pp - ETP
datos_cogoti$BAL <- datos_cogoti$pmen - datos_cogoti$ETP_har
```

## Calcular SPEI a 3 y 12 meses – Estación Cogotí

```{r, include=FALSE}
dummy_spei_cogoti <- capture.output({
  spei3_cogoti  <- spei(datos_cogoti$BAL, 3)
  spei12_cogoti <- spei(datos_cogoti$BAL, 12)
})
```

## Gráficos SPEI – Estación Cogotí

```{r}
# SPEI 12 meses – Cogotí
plot(
  spei12_cogoti$fitted,
  type = "l",
  main = "SPEI (12 meses) – Estación Cogotí",
  xlab = "Tiempo",
  ylab = "SPEI"
)
abline(h = c(-2, -1, 0, 1, 2), lty = c(2, 3, 1, 3, 2))

# SPEI 3 meses – Cogotí
plot(
  spei3_cogoti$fitted,
  type = "l",
  main = "SPEI (3 meses) – Estación Cogotí",
  xlab = "Tiempo",
  ylab = "SPEI"
)
abline(h = c(-2, -1, 0, 1, 2), lty = c(2, 3, 1, 3, 2))
```

## Calcular ETP y balance hídrico – Estación Ramadas

```{r, include=FALSE}
# Capturamos lo que imprime hargreaves para Ramadas
dummy_out_ramadas <- capture.output({
  datos_ramadas$ETP_har <- hargreaves(
    datos_ramadas$tmin,
    datos_ramadas$tmax,
    lat = -31.035833
  )
})

# Balance Pp - ETP
datos_ramadas$BAL <- datos_ramadas$pmen - datos_ramadas$ETP_har
```

## Calcular SPEI a 3 y 12 meses – Estación Ramadas

```{r, include=FALSE}
dummy_spei_ramadas <- capture.output({
  spei3_ramadas  <- spei(datos_ramadas$BAL, 3)
  spei12_ramadas <- spei(datos_ramadas$BAL, 12)
})
```

## Gráficos SPEI – Estación Ramadas

```{r}
# SPEI 12 meses – Ramadas
plot(
  spei12_ramadas$fitted,
  type = "l",
  main = "SPEI (12 meses) – Estación Ramadas",
  xlab = "Tiempo",
  ylab = "SPEI"
)
abline(h = c(-2, -1, 0, 1, 2), lty = c(2, 3, 1, 3, 2))

# SPEI 3 meses – Ramadas
plot(
  spei3_ramadas$fitted,
  type = "l",
  main = "SPEI (3 meses) – Estación Ramadas",
  xlab = "Tiempo",
  ylab = "SPEI"
)
abline(h = c(-2, -1, 0, 1, 2), lty = c(2, 3, 1, 3, 2))
```
